<% title "Subsidiaries of #{@event.name}" %>
<% page_md %>
<%= render "events/nav", selected: :sub_organizations %>

<h1 class="heading flex">
  <span class="flex-grow">Sub-organizations</span>
  <%= pop_icon_to "download",
                  { format: :csv },
                  class: "align-middle tooltipped tooltipped--w", "aria-label": "Download all as CSV" %>
  <%= link_to "#", class: "btn bg-success", data: { behavior: "modal_trigger", modal: "create" }, disabled: !policy(@event).create_sub_organization? do %>
    <%= inline_icon "plus" %>
    Create a subsidiary
  <% end %>
</h1>

<div class="flex items-center details-horiz details-horiz--lg mb-2" style="gap: 8px; pointer-events: none;">
    <div class="flex items-center details-horiz details-horiz--lg" style="gap: 8px; pointer-events: none;">
      <div class="stat statset__wide" data-tour-step="balance">
        <span class="stat__label">Sub-organization balance</span>
        <span class="stat__value">
          <%= render_money_amount(@event.descendant_total_balance_cents) %>
        </span>
      </div>
    </div>
</div>

<div class="flex items-center gap-6 sm:gap-4 flex-col-reverse sm:flex-row mb2">
  <%= form_with(model: false, local: true, method: :get, class: "flex-1 w-full sm:w-auto") do |form| %>
    <%= render "search", form: %>
  <% end %>
</div>

<ul class="grid grid--medium-narrow left-align w-100 mt0">
  <%= render partial: "events/event_card", collection: @sub_organizations, as: :event, locals: { show_scoped_tags: true } %>
</ul>

<% if policy(@event).create_sub_organization? %>
  <section data-behavior="modal" role="dialog" id="create" class="modal modal--scroll bg-snow">
    <%= form_with(url: event_create_sub_organization_path(@event.slug), method: :post, html: { class: "[&_input]:max-w-full [&_textarea]:!max-w-full", "x-data" => "{ scoped_tags: [] }" }) do |form| %>
      <%= modal_header "Create a sub-organization" %>
      <div class="card border b--info mt2 mb2 container--sm mx-auto">
        <p class="mt0 mb0">
          Sub-organizations are subsidiaries of your organization. All members of <%= @event.name %> can access and view sub-organizations, but only managers can create and edit them.
        </p>
      </div>

      <div class="field">
        <%= form.label :name, "Project name", class: "bold" %>
        <%= form.text_field :name, placeholder: "#{possessive(@event.name)} latest project", value: params[:name] %>
      </div>

      <div class="field">
        <%= form.label :email, "Organizer email", class: "bold" %>
        <%= form.email_field :email, placeholder: "Running this project yourself? Use #{current_user.email}", value: params[:email] %>
      </div>

      <div class="field">
        <%= form.label :cosigner_email, "Co-signer email", class: "bold" %>
        <%= form.email_field :cosigner_email, placeholder: "Include this if the organizer is under 18", value: params[:cosigner_email] %>
      </div>

      <div id="add_scoped_tag_field" class="field" data-controller="menu text-filter" data-controller="menu text-filter" data-menu-content-id-value="scoped-tag-search" data-menu-append-to-value="#add_scoped_tag_field" data-text-filter-empty-class="display-none">
        <%= form.label "scoped_tags[]", "Tags", class: "bold" %>

        <template x-for="scoped_tag in scoped_tags" :key="scoped_tag.id">
          <%= form.hidden_field "scoped_tags[]", "x-bind:value": "scoped_tag.id" %>
        </template>
        
        <template x-if="scoped_tags.length == 0">
          <p>No tags added</p>
        </template>

        <div class="flex flex-col">
          <template x-for="scoped_tag in scoped_tags" :key="scoped_tag.id">
            <span class="badge m0 w-fit">
              <span x-text="scoped_tag.name"></span>
              <button class="p0 line-height-0 bg-transparent border-none cursor-pointer link-reset" @click="scoped_tags = scoped_tags.filter(t => t.id !== scoped_tag.id)">
                <%= inline_icon "view-close", size: 16 %>
              </button>
            </span>
          </template>
        </div>
        
        <div class="flex gap-3 items-center">
          <p>Add tag</p>
          <%= text_field_tag :scoped_tag_name, nil,
                              class: "!w-fit flex-grow",
                              role: "combobox",
                              placeholder: "Search tags...",
                              "aria-controls": "scoped-tag-search",
                              data: {
                                action: "
                                  keydown.enter->text-filter#selectFirst

                                  click->menu#open
                                  focus->menu#open
                                  click@document->menu#close
                                  keydown@document->menu#keydown

                                  input->text-filter#query
                                ",
                                menu_target: "toggle",
                              } %>
        </div>
        
        <% if @event.subevent_scoped_tags.any? %>
          <div class="menu__content menu__content--2" data-menu-target="content" role="listbox" style="width: 24rem">
            <% @event.subevent_scoped_tags.each do |scoped_tag| %>
              <div class="flex items-center">
                <button
                  type="button"
                  class="menu__action flex justify-between flex-auto mr1"
                  data-action="input#focus menu#close"
                  data-tag="<%= {id: scoped_tag.id, name: scoped_tag.name}.to_json %>"
                  @click="scoped_tags.push(JSON.parse($el.dataset.tag))">
                  <span class="truncate"><%= scoped_tag.name %></span>
                </button>
                <%= link_to event_scoped_tag_path(@event, scoped_tag), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this tag?" } do %>
                  <%= inline_icon "view-close", size: 24, class: "align-middle" %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <small class="muted mt-0 mb-4">This project will be created on the <strong><%= @event.plan.label %></strong> plan</small>

      <div class="inline-block">
        <%= form.submit "Create sub-organization", class: "mt1", disabled: @event&.demo_mode? %>
      </div>
    <% end %>
  </section>
<% end %>
