<% title "Reimbursements for #{@event.name}" %>
<% page_md %>
<%= render "events/nav", selected: :reimbursements %>

<% if @reports.any? %>
<h1 class="heading gap-2 flex-col sm:flex-row mb-0 border-0">
  <span class="flex-grow">Reimbursements</span>
  <div class="flex items-center gap-2">
    <%= pop_icon_to "download",
                  reimbursements_exports_path(@event, format: :csv),
                  class: "tooltipped tooltipped--s", "aria-label": "Download CSV export" %>
    <%= pop_icon_to "settings",
        edit_event_path(@event, tab: "reimbursements"),
        data: { turbo_frame: "_top", behavior: "modal_trigger", modal: "reimbursement_settings" },
        class: "tooltipped tooltipped--s", "aria-label": "Reimbursements settings" if organizer_signed_in?(as: :member) %>
    <% if @event.public_reimbursement_page_available? %>
      <%= pop_icon_to "external",
          reimbursement_start_reimbursement_report_url(@event),
          target: "_blank",
          class: "tooltipped tooltipped--s", "aria-label": "Public form" %>
    <% end %>
    <% if organizer_signed_in?(as: :member) %>
      <%= pop_icon_to "plus",
            "#",
            class: "tooltipped tooltipped--s success sm-hide md-hide lg-hide",
            "aria-label": "New report",
            data: { behavior: "modal_trigger", modal: "create_reimbursement_report" } %>
      <%= link_to "#", class: "btn bg-success xs-hide", data: { behavior: "modal_trigger", modal: "create_reimbursement_report" } do %>
          <%= inline_icon "plus" %> New
      <% end %>
    <% end %>
  </div>
</h1>

<%= render partial: "reimbursement/reports/create_form" %>

<div class="statset mb-2">
  <div class="stat">
    <span class="stat__label">
      Total
    </span>
    <span class="stat__value" style="text-wrap: nowrap"><%= render_money_amount(@total) %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Reimbursed</span>
    <span class="stat__value"><%= render_money_amount(@reimbursed) %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Pending</span>
    <span class="stat__value"><%= render_money_amount(@pending) %></span>
  </div>
</div>

<div class="flex items-center gap-2">
  <%= form_with(model: false, local: true, method: :get, class: "flex-1 w-full sm:w-auto") do |form| %>
    <%= render "events/search", form: %>
  <% end %>
  <%= render "events/filters/menu", filters: @filter_options unless @has_filter %>
</div>

<%= render "events/filters/bar", filters: @filter_options if @has_filter %>

<% if @reports.blank? %>
  <%= blankslate "No reports found!" %>
<% else %>
  <article class="table-container">
    <table>
      <thead>
      <tr>
        <th>Status</th>
        <th>Report</th>
        <th>From</th>
        <th class="text-right">Amount</th>
        <th class="text-right">Created</th>
      </tr>
      </thead>
      <tbody>
        <% @reports.order(created_at: :desc).each do |report| %>
          <tr class="clickable">
            <td>
              <% if report.status_description %>
                <span class="ml0 badge bg-<%= report.status_color %> tooltipped tooltipped--e tooltipped--xl" aria-label="<%= report.status_description %>">
                  <%= report.status_text %>
                </span>
              <% else %>
                <span class="ml0 badge bg-<%= report.status_color %>"><%= report.status_text %></span>
              <% end %>
            </td>
            <td style="max-width: 500px; overflow: hidden; text-overflow: ellipsis;">
              <%= link_to "", report, class: "stretched-link" %>
              <span class="muted"><%= report.name %></span>
            </td>
            <td style="width: 200px; overflow: hidden; text-overflow: ellipsis;">
               <%= user_mention report.user %>
            </td>
            <td class="text-right">
               <%= report.amount.format %>
            </td>
            <td class="text-right">
               <%= format_date report.created_at %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </article>

  <%= paginate @reports %>

  <p class="italic muted text-center">
    <%= page_entries_info @reports, entry_name: "reports" %>.
  </p>
<% end %>
<% else %>
  <div class="grid grid-cols-5 h-[calc(100vh-60px)] gap-20 px-3">
    <div class="flex flex-col justify-center col-span-2">
      <h1 class="heading border-0 mb-0">
        Reimbursements
      </h1>

      <div class="-mx-4">
        <div class="btn btn--list-item pointer-events-none items-start">
          <%= inline_icon "send", class: "mt-1" %>
            <div>
              <strong>Manage out-of-pocket expenses</strong>
              <p class="text-sm opacity-60">
                Easily track and reimburse expenses incurred by your team members during events.
              </p>
            </div>
        </div>
        <div class="btn btn--list-item pointer-events-none items-start">
          <%= inline_icon "payment", class: "mt-1" %>
            <div>
              <strong>
                Four different methods
              </strong>
              <p class="text-sm opacity-60">
                Reimburse via ACH, mailed checks, Wise, or Wire transfers to suit your team's needs.
              </p>
            </div>
        </div>
        <div class="btn btn--list-item pointer-events-none items-start">
          <%= inline_icon "copy", class: "mt-1" %>
            <div>
              <strong>Upload receipts</strong>
              <p class="text-sm opacity-60">
                Organize and store expense receipts to track each expense easily.
              </p>
            </div>
        </div>
      </div>

      <% if organizer_signed_in?(as: :member) %>
        <%= link_to new_event_invoice_path(event_id: @event.slug),
            class: "btn btn--icon bg-success mt-3",
            data: { behavior: "modal_trigger", modal: "new_invoice" } do %>
          <%= inline_icon "send" %>
          Send an invoice
        <% end %>
      <% end %>
    </div>
    <div class="col-span-3 flex items-center justify-center">
      <div class="card p-0 card--breakdown">
        <img src="https://hc-cdn.hel1.your-objectstorage.com/s/v3/ea38bca4b45ea898_image.png" alt="Invoice illustration" class="w-full h-auto dark:hidden">
        <img src="https://hc-cdn.hel1.your-objectstorage.com/s/v3/4c5f86c3d3366341_image.png" alt="Invoice illustration" class="w-full h-auto hidden dark:block">
        <div class="p-2 pt-0 text-center">
          <span class="text-sm text-muted">See <a href="https://hcb.hackclub.com/hq/invoices" target="_blank" class="underline">how we do invoices on HQ!</a></span>
        </div>
      </div>
    </div>
  </div>
<% end %>

<%= form_with(model: Reimbursement::Report, class: "display-none", method: :post, url: quick_expense_reimbursement_reports_path, data: { controller: "file-drop form", "file-drop-title-value": "Drop to start a report." }) do |form| %>
  <%= form.hidden_field :event_id, value: @event.id %>
  <%= form.label :file, "Choose file", class: "field--fileupload__label", data: {
        action: "
        dragover@window->file-drop#dragover
        drop@window->file-drop#drop
        dragenter@window->file-drop#dragenter
        dragleave@window->file-drop#dragleave
      "
      } %>
  <%= form.file_field :file,
      multiple: true,
      include_hidden: false,
      required: false,
      accept: "image/*,image/heic,.pdf",
      data: {
        "file-drop-target" => "fileInput",
        "action"           => "change->form#submit"
      } %>
  </div>
<% end %>

<section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="reimbursement_settings">
  <%= modal_header("Settings", external_link: edit_event_path(@event, tab: "reimbursements")) %>
  <%= turbo_frame_tag :reimbursements_settings, src: edit_event_path(@event, tab: "reimbursements", params: { frame: true }), loading: "lazy" do %>
    <strong>Loading...</strong>
  <% end %>
</section>
