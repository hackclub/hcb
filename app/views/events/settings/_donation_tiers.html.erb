<% if @frame %>
  <div class="menu__divider m-0 my-8"></div>
<% end %>
<div data-controller="accordion" class="card mt-4">
  <div class="field field--checkbox mb0">
    <div>
      <span style="font-weight: 700">Enable donation tiers</span>
      <p class="text-muted mt-0.5 mb-0 text-sm">
        Offer preset monthly donation options with custom names, prices, and perks.
      </p>
    </div>
    <div class="field--checkbox--switch ml-auto" style="flex-shrink:0">
      <%= form_with(model: event, local: true) do |form| %>
        <%= form.label :donation_tiers_enabled do %>
          <%= form.check_box :donation_tiers_enabled,
            data: { action: "change->accordion#toggle", target: "accordion.checkbox" },
            disabled:,
            checked: @event.donation_tiers_enabled,
            onchange: "this.closest('form').requestSubmit();",
            switch: true %>
          <span class="slider"></span>
        <% end %>
      <% end %>
    </div>
  </div>
  <div data-accordion-target="content" class="rounded-xl">
    <div class="field mt-5">
      <%= form_with(url: event_donation_tiers_path(event), local: true, method: :patch) do |form| %>
        <ul
          class="list-none p-0 m-0 flex flex-col gap-2"
          data-controller="sortable event-sort"
          data-sortable-append-to-value="body"
          data-sortable-handle-value=".draggable-handle"
          data-event-sort-organizer-positions-value="<%= event.donation_tiers.pluck(:id).to_json %>"
          data-action="sortable:stop->event-sort#sort">
          <% event.donation_tiers.each do |tier| %>
            <div class="draggable card shadow-none border bg-gray-50 flex items-start gap-2 mb-2 transition-none">
              <div class="flex-1">
                <div class="flex gap-2 w-full">
                  <input type="text" class="flex-1 !max-w-full" placeholder="Tier name" name="tiers[<%= tier.id %>][name]" value="<%= tier.name %>" required onblur="this.form.requestSubmit();">
                  <div class="flex items-center gap-2 border rounded-md px-3 input min-w-0 p-0 max-w-[155px]">
                    $
                    <input type="number" required class="!border-none !px-0" style="width: 50px" placeholder="Cost" name="tiers[<%= tier.id %>][amount_cents]" value="<%= tier.amount_cents / 100 %>" required onblur="this.form.requestSubmit();">
                    /month
                  </div>
                </div>
                <textarea onblur="this.form.requestSubmit();" class="w-100 max-w-full mt-1" placeholder="Description" name="tiers[<%= tier.id %>][description]"><%= tier.description %></textarea>
              </div>

              <div class="flex flex-col gap-1">
                <%= pop_icon_to "drag-indicator", "#", class: "draggable-handle cursor-move" %>
                <%= pop_icon_to "delete", event_donation_tiers_path(event, tier), method: :delete, data: { turbo_confirm: "Are you sure?" } %>
              </div>
            </div>
          <% end %>
        </ul>
      <% end %>
      <%= form_with(url: event_donation_tiers_path(event), local: true, method: :post) do |form| %>
        <div class="flex justify-end px-1 my-3 items-center">
          <span class="muted block text-sm flex-1">Changes will be saved automatically</span>
          <button type="submit" class="btn bg-muted gap-4 pr-2">
            Create tier
            <%= inline_icon "plus" %>
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>
