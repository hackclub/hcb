<% @destination = @hcb_code.disbursement.destination_event %>
<% @source = @hcb_code.disbursement.source_event %>
<% @subledger = @hcb_code.disbursement.destination_subledger || @hcb_code.disbursement.source_subledger %>

<article class="card pb0 mt3 mb1">
  <%= render "heading", hcb_code: @hcb_code do %>
    <span style="flex-grow: 1">
      <%= @source.name %>
      <span class="regular muted">
        <% if @hcb_code.disbursement.fulfilled? || (@destination.can_front_balance? && (@hcb_code.disbursement.processed? || @hcb_code.disbursement.pending?)) %>
          transferred
        <% elsif @hcb_code.disbursement.processed? || @hcb_code.disbursement.pending? %>
          transferring
        <% else %>
          transfer of
        <% end %>
      </span>
      <span class="regular"><%= render_money @hcb_code.disbursement.amount %></span>
      <span class="regular muted">to</span>
      <%= @destination.name %>
    </span>
    <span class="badge h4 md-right bg-<%= @hcb_code.disbursement.state %>">
      <%= @hcb_code.disbursement.state_text.humanize %>
      <%= inline_icon @hcb_code.disbursement.state_icon, size: 20 if @hcb_code.disbursement.state_icon %>
    </span>
  <% end %>

  <section class="card__banner card__darker details-horiz border-top border-bottom">
    <% unless @hcb_code.disbursement.requested_by.nil? %>
      <p>
        <% if @hcb_code.disbursement.reviewing? || @hcb_code.disbursement.rejected? %>
          <strong>Requested by</strong>
        <% else %>
          <strong>Sent by</strong>
        <% end %>
        <%= user_mention @hcb_code.disbursement.requested_by %>
      </p>
    <% end %>

    <% unless @hcb_code.disbursement.authorized_by.nil? %>
      <p>
        <strong>Authorized by</strong>
        <%= user_mention @hcb_code.disbursement.authorized_by %>
      </p>
    <% end %>

    <% unless @hcb_code.disbursement.fulfilled_by.nil? %>
      <% admin_tool("", "p") do %>
        <strong>Fulfilled by</strong>
        <%= user_mention @hcb_code.disbursement.fulfilled_by %>
      <% end %>
    <% end %>

    <p>
      <% if @hcb_code.disbursement.processed? %>
        <strong>Transferred at</strong>
        <%= format_datetime @hcb_code.disbursement.transferred_at %>
      <% else %>
        <strong>Requested at</strong>
        <%= format_datetime @hcb_code.disbursement.created_at %>
        <% admin_tool("", "p") do %>
          <% if @hcb_code.disbursement.scheduled_on.present? && !@hcb_code.disbursement.processed? %>
            <strong>Scheduled at</strong>
            <%= @hcb_code.disbursement.scheduled_on.strftime("%B %e, %Y") %>
          <% end %>
        <% end %>
      <% end %>
      <% admin_tool("", "p") do %>
        <strong>Disbursement ID</strong>
        <%= link_to @hcb_code.disbursement.id, @hcb_code.disbursement %>
      <% end %>
    </p>

  </section>

  <section class="details pt2 pb2">
    <% if @subledger&.card_grant.present? %>
      <p>
        <strong>Event</strong>
        <%= link_to @destination.name, @destination %>
      </p>
      <p>
        <strong>Grant</strong>
        <%= link_to_if @subledger.card_grant.stripe_card.present?, "Grant to #{@subledger.card_grant.user.name}", @subledger.card_grant.stripe_card %>
      </p>
    <% else %>
      <p>
        <strong>From</strong>
        <%= link_to @source.name, @source, target: "_top" %>
      </p>

      <p>
        <strong>To</strong>
        <%= link_to @destination.name, @destination, target: "_top" %>
      </p>
    <% end %>

    <p>
      <strong>Amount</strong>
      <%= render_money @hcb_code.disbursement.amount %>
    </p>

    <p>
      <strong>Reason</strong>
      <%= @hcb_code.disbursement.name %>
    </p>

    <% if @hcb_code.disbursement.fulfilled? %>
      <p>
        <strong>Confirmation letter</strong>
          <span class="muted">
            <a href="/disbursements/<%= @hcb_code.disbursement.id %>/confirmation.pdf" target="_blank">
            <%= "View confirmation letter" %>
            </a>
          </span>
      </p>
    <% end %>

    <%= render "hcb_codes/tags", hcb_code: @hcb_code, event: @event || @hcb_code.event %>

  </section>

    <% is_manager = OrganizerPosition.role_at_least?(current_user, @hcb_code.disbursement.source_event, :manager) %>
    <% is_requester = current_user == @hcb_code.disbursement.requested_by %>

    <% if @hcb_code.disbursement.authorizing? && (is_manager || is_requester) %>
      <article class="border <%= is_manager ? "b--info" : "b--warning" %> card card--sunken--dark mb-4 flex flex-col gap-3 lg:flex-row justify-between items-center">
        <% if is_manager %>
          <div>
            <div class="flex items-center info">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414" aria-label="info" clip-rule="evenodd" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32" class="mr1" style=""><g><path fill-rule="evenodd" d="M26 16c0 5.523-4.477 10-10 10S6 21.523 6 16 10.477 6 16 6s10 4.477 10 10zm2 0c0 6.627-5.373 12-12 12S4 22.627 4 16 9.373 4 16 4s12 5.373 12 12z" clip-rule="evenodd"></path><path d="M16 12.75a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM16 22.25c-.552 0-1-.392-1-.875v-6.25c0-.483.448-.875 1-.875s1 .392 1 .875v6.25c0 .483-.448.875-1 .875z"></path></g></svg>
              <p class="bold mt0 mb0">This transfer requires manager review</p>
            </div>

            <p>This transfer requires your authorization because <%= @hcb_code.disbursement.requested_by.name %> is a member. Authorize <%= render_money @hcb_code.disbursement.amount %> to <%= @hcb_code.disbursement.destination_event.name %>?</p>
            <div class="flex items-center gap-2">
              <%= button_to "Authorize", disbursement_manager_authorize_path(@hcb_code.disbursement), method: :post, class: "btn bg-success" %>
              <%= button_to "Reject", disbursement_manager_reject_path(@hcb_code.disbursement), method: :post, class: "btn bg-error" %>
            </div>
          </div>
        <% else %>
          <div>
            <div class="flex items-center warning">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414" aria-label="info" clip-rule="evenodd" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32" class="mr1" style=""><g><path fill-rule="evenodd" d="M26 16c0 5.523-4.477 10-10 10S6 21.523 6 16 10.477 6 16 6s10 4.477 10 10zm2 0c0 6.627-5.373 12-12 12S4 22.627 4 16 9.373 4 16 4s12 5.373 12 12z" clip-rule="evenodd"></path><path d="M16 12.75a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM16 22.25c-.552 0-1-.392-1-.875v-6.25c0-.483.448-.875 1-.875s1 .392 1 .875v6.25c0 .483-.448.875-1 .875z"></path></g></svg>
              <p class="bold mt0 mb0">This transfer requires manager review</p>
            </div>

            <p>Because you're a member of <%= @hcb_code.disbursement.source_event.name %>, you'll need to get a <%= link_to "manager", event_team_path(@hcb_code.disbursement.source_event, filter: :managers) %> to authorize this transfer.</p>

            <div class="relative block max-w-[400px]" data-controller="clipboard" data-clipboard-text-value="<%= hcb_code_url(@hcb_code) %>">
              <input id="transfer_link" type="text" value="<%= hcb_code_url(@hcb_code) %>" readonly style="cursor: text;" class="fit border dark:[&:not(:focus)]:!border-darkless border-1">
              <button
                type="button"
                class="pointer pop mr2 align-middle tooltipped tooltipped--n"
                style="position: absolute; top: 50%; right: -8px; transform: translateY(-50%) scale(0.9);"
                aria-label="Copy transfer link"
                data-action="clipboard#copy:prevent">
                <%= inline_icon "copy", size: 28 %>
              </button>
            </div>

          </div>

        <% end %>
      </article>
    <% end %>

  <% if @event.can_front_balance? %>
    <section class="card__banner card__darker secondary border-top flex items-center g2">
      <% if @hcb_code.disbursement.may_mark_rejected? %>
        <% admin_tool "w-fit" do %>
          <%= button_to "Process", disbursement_process_admin_path(@hcb_code.disbursement), class: "btn", method: :get, data: { turbo_frame: "_top" } %>
        <% end %>
      <% end %>

      <% if @hcb_code.disbursement.scheduled? %>
        <% admin_tool "w-fit" do %>
          <%= button_to "Cancel transfer", disbursement_cancel_path(@hcb_code.disbursement), class: "btn bg-error" %>
        <% end %>
      <% end %>

      <p class="my0 italic">
        HCB transfers are immediately reflected in your account balance.
      </p>
    </section>
  <% end %>

</article>
