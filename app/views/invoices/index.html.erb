<% title "Invoices for #{@event.name}" %>
<% page_md %>
<%= render "events/nav", selected: :invoices %>

<h1 class="heading gap-2 flex-col sm:flex-row border-0 mb-2">
  <span class="flex items-center">
    Invoices
    <%= badge_for @invoices.size, class: "bg-muted" %>
  </span>

  <% if organizer_signed_in?(as: :member) %>
    <%= link_to new_event_invoice_path(event_id: @event.slug),
        class: "!ml-0 sm:!ml-auto btn btn--icon bg-success",
        data: { behavior: "modal_trigger", modal: "new_invoice" } do %>
      <%= inline_icon "send" %>
      Send an invoice
    <% end %>
  <% end %>
</h1>

<% if organizer_signed_in? %>
  <%= render "invoices/modal" %>
<% end %>

<div class="statset mb-2">
  <div class="stat tooltipped tooltipped--s" aria-label="This excludes archived invoices">
    <span class="stat__label">Total invoiced</span>
    <span class="stat__value"><%= render_money_amount @stats[:total] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Already received</span>
    <span class="stat__value"><%= render_money_amount @stats[:paid] %></span>
  </div>
  <div class="stat stat--small tooltipped tooltipped--s" aria-label="This excludes archived invoices">
    <span class="stat__label">Unpaid</span>
    <span class="stat__value"><%= render_money_amount @stats[:unpaid] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">On the way</span>
    <span class="stat__value"><%= render_money_amount @stats[:pending] %></span>
  </div>
</div>

<div class="flex items-center gap-2">
  <%= form_with(model: false, local: true, method: :get, class: "flex-1 w-full sm:w-auto") do |form| %>
    <%= render "events/search", form: %>
  <% end %>

  <%= render "events/filters/menu", filters: @filter_options unless @has_filter %>
</div>

<%= render "events/filters/bar", filters: @filter_options if @has_filter %>

<% if @invoices.size > 0 %>
<article class="table-container">
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Date</th>
      <th>To</th>
      <th class="text-right">Amount</th>
    </tr>
  </thead>

  <tbody>
    <% @invoices.each do |i| %>
      <tr class="clickable">
        <td>
          <span class="ml0 badge bg-<%= i.state %>"><%= i.state_text %></span>
        </td>
        <td>
          <%= format_date i.created_at %>
        </td>
        <td>
          <%= i.sponsor.name %>
        </td>
        <td style="text-align: right;">
          <%= render_money(i.item_amount) %>
          <%= link_to "", hcb_code_url(i.local_hcb_code.hashid), class: "stretched-link", data: popovers_enabled? && popover_data(title: "#{i.sponsor.name} invoiced for #{render_money(i.item_amount)}", src: i.local_hcb_code.popover_path, frame_id: i.local_hcb_code.public_id, state_url: hcb_code_url(i.local_hcb_code.hashid), external_link: hcb_code_url(i.local_hcb_code.hashid)) if organizer_signed_in? %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
</article>
<% else %>
  <%= blankslate "No invoices yet" %>
<% end %>
