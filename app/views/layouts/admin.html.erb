<% @is_dark = !!@dark || cookies[:theme] == "dark" || (cookies[:theme] == "system" && cookies[:system_preference] == "dark") %>

<!DOCTYPE html>
<html lang="en" data-dark="<%= @is_dark %>">
  <head>
    <title>
      <%= "#{yield(:title)} â€“" if content_for?(:title) %>
      HCB Admin
    </title>

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= javascript_include_tag "dark", 'data-turbo-track': "reload" %>
    <%= stylesheet_link_tag "admin", media: "all", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "admin", "data-turbo-track": "reload", defer: true %>
    <%= javascript_include_tag "bundle", 'data-turbo-track': "reload", defer: true %>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-<%= Rails.env %>-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-<%= Rails.env %>-16x16.png">
    <%= yield(:head) if content_for?(:head) %>
  </head>
  <body class="bg-snow">
    <a class="skip-to-main" href="#main">Skip to main content</a>

    <% title = yield(:title) if content_for?(:title) %>

    <% nav = Admin::Nav.new(page_title: title) %>

    <nav class="flex flex-col shadow-lg sticky top-0 backdrop-blur-lg z-10 bg-white/80 dark:bg-[rgba(0,0,0,.7)]">
      <div class="p-6 pl-5 pb-2 flex items-center w-full gap-2">
        <%= render "application/logo" %>

        <span class="text-xl font-bold ml-1">HCB Admin</span>
        <span style="color: var(--hcb-link-2); font-weight: 200;">/</span>

        <% if title %>
          <% if nav.active_section&.name %>
          <span>
            <%= nav.active_section&.name %>
          </span>
          <span style="color: var(--hcb-link-2); font-weight: 200;">/</span>
          <% end %>
          <span>
            <%= title %>
          </span>
        <% else %>
          <b>
            <%= current_user.access_level.capitalize %>
          </b>
        <% end %>

        <div style="flex-grow: 1; display: flex; gap: 8px; height: 28px; justify-content: flex-end;">
          <%= link_to my_inbox_path, 'aria-label': "View transactions awaiting receipts", class: "tooltipped tooltipped--w" do %>
            <%= inline_icon "receipt", size: home_action_size %>
          <% end %>
          <%= button_to logout_users_path, method: :delete, id: "admin-logout-button", 'aria-label': "Sign out", class: "tooltipped tooltipped--w" do %>
            <%= inline_icon "door-leave", size: home_action_size %>
          <% end %>
        </div>
      </div>

      <div class="nav-row !border-gray-200 dark:!border-gray-700 py-2" style="width: 100%; display: flex;border-top:1px solid">
        <% nav.sections.each do |section| %>
          <details open class="admin-nav-item pb-0 flex-1">
            <summary class="nav-item" style="<%= section.active? ? "color: var(--hcb-accent)" : "color: var(--hcb-tx-1)" %>">
              <%= section.name %>
              <span class="badge <%= section.task_sum > 0 ? "bg-success" : "bg-muted" %> h-fit-content">
                <%= section.task_sum > 0 ? section.task_sum : section.counter_sum %>
              </span>
            </summary>
            <div class="dropdown">
              <div class="sub-items" style="backdrop-filter:blur(10px)">
                <% section.items.each do |item| %>
                  <%= link_to item.path, style: item.active? ? "color: var(--hcb-accent)" : "color: var(--hcb-tx-1)" do %>
                    <%= item.name %>
                    <span class="badge <%= item.record_count? || item.count.zero? ? "bg-muted" : "" %> h-fit-content ml-auto">
                      <%= item.count %>
                    </span>
                  <% end %>
                <% end %>
              </div>
            </div>
          </details>
        <% end %>
      </div>
    </nav>

    <%= render(partial: "admin/flash") %>

    <div id="main" class="overflow-x-auto overflow-y-auto" style="padding: 2rem; margin: 0 auto">
      <%= yield %>
    </div>

    <%= render "application/command_bar" %>
    <script>
      document.addEventListener("turbo:load", () => {
        const updateAdminDropdowns = () => {
          let details = document.querySelectorAll(".admin-nav-item");
          if(window.innerWidth >= 800){
            details.forEach((detail) => {
              detail.open = true;
            });
          }
          else {
            details.forEach((detail) => {
              detail.open = false;
            });
          }
        }
        updateAdminDropdowns()
        window.onresize = updateAdminDropdowns
      })
    </script>
  </body>
</html>
