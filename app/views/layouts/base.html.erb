<% @is_dark = !!@dark || cookies[:theme] == "dark" || (cookies[:theme] == "system" && cookies[:system_preference] == "dark") unless @skip_dark_mode %>

<!DOCTYPE html>
<html lang="en" <%= content_for?(:html_attributes) ? yield(:html_attributes) : "data-dark=\"#{@is_dark}\"".html_safe %>>
  <!-- come hack with us on hcb! <%= yield(:github_url) if content_for?(:github_url) %><%= Rails.configuration.constants.github_url unless content_for?(:github_url) %> -->
  <head>
    <title>
      <%= yield(:title).concat(" â€“") if content_for?(:title) %>
      <%= content_for?(:title_suffix) ? yield(:title_suffix) : "HCB" %>
    </title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= content_for?(:custom_meta_tags) ? yield(:custom_meta_tags) : nil %>
    <meta name="theme-color" content="<%= @is_dark ? "#17171d" : "#f9fafc" %>">

    <%= yield(:before_assets) if content_for?(:before_assets) %>

    <%= javascript_include_tag "dark", 'data-turbo-track': "reload" unless content_for?(:skip_dark_js) %>
    <%= stylesheet_link_tag "application", media: "all", 'data-turbo-track': "reload" unless content_for?(:custom_stylesheet) %>
    <%= yield(:custom_stylesheet) if content_for?(:custom_stylesheet) %>
    <%= javascript_include_tag "application", 'data-turbo-track': "reload", defer: true unless content_for?(:custom_application_js) %>
    <%= yield(:custom_application_js) if content_for?(:custom_application_js) %>
    <%= javascript_include_tag "bundle", 'data-turbo-track': "reload", defer: true %>

    <%= yield(:additional_scripts) if content_for?(:additional_scripts) %>

    <% if Rails.env.production? %>
      <script defer data-domain="hcb.hackclub.com" src="https://plausible.io/js/script.pageview-props.tagged-events.js"></script>
    <% end %>

    <% unless Rails.env.production? %>
      <meta name="turbo-prefetch" content="false">
    <% end %>

    <% if Rails.env.production? && !content_for?(:skip_console_art) %>
      <script>
        console.log(`%c                -*%@@%*-
              .=#@@@@@@@@@@#=.
          .=%@@@@@*-..-*@@@@@%=.
        -#@@@@@+:        :+@@@@@#-
      :*@@@@@*:              :*@@@@@*:
    =%@@@@#-                    -#@@@@%=.
  *@@@@@+.                        .+@@@@@*
  *@@*-   *@@*      *@@*      *@@*   :*@@*
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          @@@@      @@@@      @@@@
          *@@*      *@@*      *@@*

    *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*
    *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*

          Come hack on HCB with us!
  <%= yield(:console_art_url) if content_for?(:console_art_url) %><%= Rails.configuration.constants.github_url unless content_for?(:console_art_url) %> <%# erb_lint:disable ErbSafety %>
  `, 'color: #ec3750; font-weight: bold; font-size: 10px;')
      </script>
    <% end %>

    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <% if content_for?(:favicon) %>
      <%= yield :favicon %>
    <% elsif user_birthday? %>
      <link rel="icon" type="image/png" href="/favicon-party.gif">
    <% else %>
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-<%= Rails.env %>-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-<%= Rails.env %>-16x16.png">
    <% end %>
    <link rel="manifest" href="/site.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ec3750">
    <meta name="msapplication-TileColor" content="#ec3750">
    <%= yield(:additional_head_tags) if content_for?(:additional_head_tags) %>
    <%= yield(:head) if content_for?(:head) %>
  </head>
  <body <%= yield(:body_attributes) if content_for?(:body_attributes) %> class="<%= content_for?(:body_class) ? yield(:body_class) : "bg-snow embedded #{content_for :page_class} #{"season-#{current_season}" if current_season}" %>">
    <%= yield(:body_prefix) if content_for?(:body_prefix) %>

    <%# LET THERE BE SNOW %>
    <% if winter? && !content_for?(:skip_seasonal) %>
      <%= react_component "holiday/Snow", {}, { style: content_for?(:snow_style) ? yield(:snow_style) : "height:100%" } %>
    <% end %>

    <%# ghosts and ghouls %>
    <% if fall? && !content_for?(:skip_seasonal) %>
      <img src="https://hc-cdn.hel1.your-objectstorage.com/s/v3/7e4929972e5eee4c_image.png" alt="oOoOoOoOo" class="flying-spook ghost">
      <img src="https://hc-cdn.hel1.your-objectstorage.com/s/v3/1106e43a5e5219cf_image.png" alt="witch orpheus" class="flying-spook">
    <% end %>

    <%= yield %>

    <% if Rails.env.production? && !content_for?(:skip_fullstory) %>
      <%= render "application/fullstory" if current_user&.sessions_reported %>
    <% end %>

    <%= yield(:body_suffix) if content_for?(:body_suffix) %>

    <% if flash[:confetti] && !content_for?(:skip_confetti) %>
      <script src="/brand/js-confetti.browser.js"></script>
      <script>
        const triggerConfetti = () => {
          const jsConfetti = new JSConfetti()
          const emojis = <%= flash[:confetti_emojis].to_json.html_safe %>

          setTimeout(() => {
            if (!emojis) {
              jsConfetti.addConfetti()
            } else {
              jsConfetti.addConfetti({
                emojis: emojis.split(",")
              })
            }
          }, 100);
        };

        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        (async () => {
          while (typeof JSConfetti == "undefined") {
            await sleep(500);
          }

          triggerConfetti()
        })();
      </script>
    <% end %>
    <% if Flipper.enabled?(:transactions_background_2024_06_05, current_user) %>
      <style>
          .success-dark {
              color: #1f8164
          }
      </style>
    <% end %>
  </body>
</html>
