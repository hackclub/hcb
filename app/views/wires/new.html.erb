<% disabled = !policy(@event).create_transfer? %>

<% title "Send a wire" %>

<% if @event.present? && !policy(@event).create_transfer? %>
  <%= render partial: "events/unauthorized_callout", locals: { action: "send a wire" } %>
<% end %>

<% content_for :table_of_contents do %>
  <div class="step-tab step-tab--full justify-start py-1" data-scroll-seek-target="tab">
    <div class="step-tab__number">1</div>
    <span>Recipient details</span>
  </div>
  <div class="step-tab step-tab--full justify-start py-1" data-scroll-seek-target="tab">
    <div class="step-tab__number">2</div>
    <span>Payment information</span>
  </div>
<% end %>

<% content_for :sidebar_footer do %>
  <%= render partial: "wires/requirements", locals: { event: @event } %>
<% end %>

<%= form_with(model: [@event, @wire], local: true, html: { "x-data": "{ country: #{@wire.recipient_country ? "'#{@wire.recipient_country}'" : "null"} }" }) do |form| %>
  <%= form_errors(@wire, "wire", "We couldn't send this") %>

  <div data-scroll-seek-target="section" id="recipient-details">
    <h3 class="mb-2">Recipient details</h3>
    <div class="card mb-4 relative">
      <div class="field">
        <%= form.label :recipient_name, "Legal name (use company name if applicable)" %>
      <span class="muted mb-1 block">May be used for tax purposes. Match the name on the recipient's account.</span>
        <%= form.text_field :recipient_name, placeholder: "Raviga Capital", class: "!max-w-full", required: true, maxlength: 250, disabled: %>
      </div>

      <div class="field">
        <%= form.label :recipient_email, "Email" %>
        <%= form.email_field :recipient_email, class: "!max-w-full", placeholder: "fionah@gmail.com", required: true, disabled: %>
      </div>

      <%= render partial: "wires/recipient_details", locals: { form:, disabled:, required: true } %>
    </div>
  </div>

  <div data-scroll-seek-target="section" id="payment-information">
    <h3 class="mb-2">Payment information</h3>

    <div class="card mb-4 relative">
      <div class="mb-4">
        <%= form.label :payment_for, "What are you paying for with this wire?" %>
        <span class="muted block mb-1">This is to help HCB keep record of our transactions.</span>
        <%= form.text_field :payment_for, class: "!max-w-full", placeholder: "Event venue", required: true, disabled: %>
      </div>

      <div class="flex mb-2 items-center gap-2 justify-between">
        <%= form.label :memo %>
        <%= form.text_field :memo, placeholder: "For venue payment...", required: true, disabled: %>
      </div>

      <div class="flex items-center gap-2 justify-between">
        <%= form.label :amount, "Currency & amount" %>
        <div class="flex items-center g1">
          <div style="width: 72px">
            <%= form.select :currency, Wire::AVAILABLE_CURRENCIES, required: true, default: "USD", disabled: %>
          </div>
          <div class="flex flex-col flex-grow">
            <%= form.number_field :amount, placeholder: "500.00", disabled: disabled || @event.balance <= 0, step: 0.01, required: true, data: { controller: "truncate-decimal", action: "truncate-decimal#truncate blur->truncate-decimal#pad" } %>
          </div>
        </div>
        <% @wire.errors.messages_for(:amount).each do |message| %>
          <div class="primary"><%= message %></div>
        <% end %>
        <% if @event.balance <= 0 %>
          <span class="error">There are no funds to transfer.<br>
        <% end %>
      </div>

      <%= render partial: "wires/account_details", locals: { form:, disabled:, required: true } %>
      <%= render partial: "wires/country_specific_details", locals: { form:, disabled:, required: true } %>

      <%= form.label :file, "Attach a receipt / invoice", class: "mt2 font-semibold" %>
      <p class="muted my-0">Required for reimbursements / goods & services payments.</p>

      <div class="field field--fileupload mt-1 mb-0" data-controller="file-drop form" data-file-drop-title-value="Drop to add a receipt.">
        <%= form.label :file, "Choose file", class: "field--fileupload__label", data: { action: "dragover@window->file-drop#dragover drop@window->file-drop#drop dragenter@window->file-drop#dragenter dragleave@window->file-drop#dragleave" } %>
        <%= form.file_field :file, multiple: true, include_hidden: false, required: false, accept: "image/*,image/heic,.pdf", style: "margin: 8px 0px", class: "field--fileupload__field", data: { "file-drop-target" => "fileInput" }, disabled: %>
        <%= inline_icon "view-close", size: 24, class: "muted", "data-behavior": "clear_input" %>
      </div>
    </div>

    <div class="actions tooltipped tooltipped--n inline-block w-full" aria-label="Your wire will be sent out on the next business day.">
      <%= form.submit "Send wire", disabled:, class: "w-full" %>
    </div>
  </div>
<% end %>
