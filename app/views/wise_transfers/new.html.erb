<% disabled = !policy(@event).create_transfer? %>

<% title "Send a Wise transfer" %>
<%= render "events/nav", selected: :transfers %>
<% page_sm %>

<% if @event.present? && !policy(@event).create_transfer? %>
  <%= render partial: "events/unauthorized_callout", locals: { action: "send a Wise transfer" } %>
<% end %>

<h1>Send a Wise transfer</h1>


<%= render "callout",
    type: "info",
    icon: "wise",
    title: "Important information about Wise transfers",
    class: "!border-[#9FE870] [&>div.flex]:text-[#163300] dark:[&>div.flex]:text-[#9FE870]",
    footer: link_to("Learn more about Wise on HCB â†’", "https://help.hcb.hackclub.com") do %>
  HCB is partnering with Wise to offer international wire transfers to over 100 countries. HCB imposes no fees or minimums, but fees charged by Wise will be passed on to you.
<% end %>


<h2>Current exchange rate</h2>

<div class="flex items-center justify-center bg-[#163300] p-4">

    <iframe
  title="fx"
  src="https://wise.com/gb/currency-converter/fx-widget/converter?sourceCurrency=GBP&targetCurrency=EUR"
  height=490
  width=100%
  frameBorder="0"
  allowtransparency="true"
></iframe>
  <script>
    const frames = document.querySelectorAll('iframe');
    const widgetFrame = frames[frames.length - 1];
    window.addEventListener('message', message => {
      if (message.source !== widgetFrame.contentWindow) {
      return;
      }
      widgetFrame.setAttribute('height', message.data.height);
    });
  </script>
</div>

<%= form_with(model: [@event, @wise_transfer], local: true, html: {
                "x-data": "{ country: #{@wise_transfer.recipient_country ? "'#{@wise_transfer.recipient_country}'" : "null"} }"
              }) do |form| %>

  <%= form_errors(@wise_transfer, "wire", "We couldn't send this") %>

  <div class="field">
    <%= form.label :memo %>
    <%= form.text_field :memo,
        placeholder: "For venue payment...",
        required: true,
        disabled: %>
  </div>

  <h2 class="mb2 mt3">Recipient details</h2>

  <div class="field mt2">
    <%= form.label :recipient_name, "Legal name (use company name if applicable)" %>
    <%= form.text_field :recipient_name, placeholder: "Raviga Capital", required: true, maxlength: 250, disabled: %>
    <span class="muted">This may be used for tax purposes; it should match the name on the recipient's bank account.</span>
  </div>

  <div class="field">
    <%= form.label :recipient_email, "Email" %>
    <%= form.email_field :recipient_email, placeholder: "fionah@gmail.com", required: true, disabled: %>
  </div>

  <%= render partial: "recipient_details", locals: { form:, disabled: } %>

  <h2 class="mb2 mt3">Payment information</h2>

  <%= form.label :amount, "Currency & amount" %>

  <div class="field">
    <div class="flex items-center g1">
      <div style="width: 72px">
        <%= form.select :currency, ::EuCentralBank::CURRENCIES + ["EUR"], required: true, default: "USD", disabled: %>
      </div>
      <div class="flex flex-col flex-grow">
        <%= form.number_field :amount,
          placeholder: "500.00",
          disabled: disabled || @event.balance <= 0,
          step: 0.01,
          required: true,
          data: { controller: "truncate-decimal", action: "truncate-decimal#truncate blur->truncate-decimal#pad" } %>
      </div>
    </div>
    <% @wise_transfer.errors.messages_for(:amount).each do |message| %>
      <div class="primary"><%= message %></div>
    <% end %>
    <% if @event.balance <= 0 %>
      <span class="error">There are no funds to transfer.<br>
    <% end %>
  </div>

  <div class="field">
    <%= form.label :payment_for, "What are you paying for with this wire?" %>
    <%= form.text_field :payment_for, placeholder: "Event venue", required: true, disabled: %>
    <span class="muted">This is to help HCB keep record of our transactions.</span>
  </div>

  <%= render partial: "country_specific_details", locals: { form:, disabled: } %>

  <%= form.label :file, "Attach a receipt / invoice", class: "mt2 semibold" %>
  <div class="field field--fileupload mb1 mt1" data-controller="file-drop form" data-file-drop-title-value="Drop to add a receipt.">
    <%= form.label :file, "Choose file", class: "field--fileupload__label", data: {
          action: "
        dragover@window->file-drop#dragover
        drop@window->file-drop#drop
        dragenter@window->file-drop#dragenter
        dragleave@window->file-drop#dragleave
      "
        } %>
    <%= form.file_field :file,
        multiple: true,
        include_hidden: false,
        required: false,
        accept: "image/*,image/heic,.pdf",
        style: "margin: 8px 0px",
        class: "field--fileupload__field",
        data: {
          "file-drop-target" => "fileInput"
        },
        disabled: %>
    <%= inline_icon "view-close", size: 24, class: "muted", "data-behavior": "clear_input" %>
  </div>

  <p class="muted mt0 mb2">Required for reimbursements / goods & services payments.</p>

  <div class="actions tooltipped tooltipped--n inline-block mt1" aria-label="Your wire will be sent out on the next business day.">
    <%= form.submit "Send wire", disabled: %>
  </div>
<% end %>
